import { ethers } from "ethers";

const FACTORY_ADDRESS = "0xb72c1Af569dC4313839067808f3e51aFb21E7Bc8";
//"0x875805B5ADdDB38f4e3496d868E1AC1fc06E59AC";
const MEME_BYTECODE = "0x608060405234801561000f575f5ffd5b50604051610bf0380380610bf083398101604081905261002e9161026e565b8282600361003c8382610381565b5060046100498282610381565b506005915061005a90508282610381565b5061006633606461006e565b505050610460565b6001600160a01b03821661009c5760405163ec442f0560e01b81525f60048201526024015b60405180910390fd5b6100a75f83836100ab565b5050565b6001600160a01b0383166100d5578060025f8282546100ca919061043b565b909155506101459050565b6001600160a01b0383165f90815260208190526040902054818110156101275760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401610093565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b0382166101615760028054829003905561017f565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516101c491815260200190565b60405180910390a3505050565b634e487b7160e01b5f52604160045260245ffd5b5f82601f8301126101f4575f5ffd5b81516001600160401b0381111561020d5761020d6101d1565b604051601f8201601f19908116603f011681016001600160401b038111828210171561023b5761023b6101d1565b604052818152838201602001851015610252575f5ffd5b8160208501602083015e5f918101602001919091529392505050565b5f5f5f60608486031215610280575f5ffd5b83516001600160401b03811115610295575f5ffd5b6102a1868287016101e5565b602086015190945090506001600160401b038111156102be575f5ffd5b6102ca868287016101e5565b604086015190935090506001600160401b038111156102e7575f5ffd5b6102f3868287016101e5565b9150509250925092565b600181811c9082168061031157607f821691505b60208210810361032f57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f82111561037c57805f5260205f20601f840160051c8101602085101561035a5750805b601f840160051c820191505b81811015610379575f8155600101610366565b50505b505050565b81516001600160401b0381111561039a5761039a6101d1565b6103ae816103a884546102fd565b84610335565b6020601f8211600181146103e0575f83156103c95750848201515b5f19600385901b1c1916600184901b178455610379565b5f84815260208120601f198516915b8281101561040f57878501518255602094850194600190920191016103ef565b508482101561042c57868401515f19600387901b60f8161c191681555b50505050600190811b01905550565b8082018082111561045a57634e487b7160e01b5f52601160045260245ffd5b92915050565b6107838061046d5f395ff3fe608060405234801561000f575f5ffd5b506004361061009b575f3560e01c80633c130d90116100635780633c130d901461011457806370a082311461011c57806395d89b4114610144578063a9059cbb1461014c578063dd62ed3e1461015f575f5ffd5b806306fdde031461009f578063095ea7b3146100bd57806318160ddd146100e057806323b872dd146100f2578063313ce56714610105575b5f5ffd5b6100a7610197565b6040516100b491906105f3565b60405180910390f35b6100d06100cb366004610643565b610227565b60405190151581526020016100b4565b6002545b6040519081526020016100b4565b6100d061010036600461066b565b610240565b604051601281526020016100b4565b6100a7610263565b6100e461012a3660046106a5565b6001600160a01b03165f9081526020819052604090205490565b6100a76102ef565b6100d061015a366004610643565b6102fe565b6100e461016d3660046106c5565b6001600160a01b039182165f90815260016020908152604080832093909416825291909152205490565b6060600380546101a6906106f6565b80601f01602080910402602001604051908101604052809291908181526020018280546101d2906106f6565b801561021d5780601f106101f45761010080835404028352916020019161021d565b820191905f5260205f20905b81548152906001019060200180831161020057829003601f168201915b5050505050905090565b5f3361023481858561030b565b60019150505b92915050565b5f3361024d85828561031d565b61025885858561039e565b506001949350505050565b60058054610270906106f6565b80601f016020809104026020016040519081016040528092919081815260200182805461029c906106f6565b80156102e75780601f106102be576101008083540402835291602001916102e7565b820191905f5260205f20905b8154815290600101906020018083116102ca57829003601f168201915b505050505081565b6060600480546101a6906106f6565b5f3361023481858561039e565b61031883838360016103fb565b505050565b6001600160a01b038381165f908152600160209081526040808320938616835292905220545f19811015610398578181101561038a57604051637dc7a0d960e11b81526001600160a01b038416600482015260248101829052604481018390526064015b60405180910390fd5b61039884848484035f6103fb565b50505050565b6001600160a01b0383166103c757604051634b637e8f60e11b81525f6004820152602401610381565b6001600160a01b0382166103f05760405163ec442f0560e01b81525f6004820152602401610381565b6103188383836104cd565b6001600160a01b0384166104245760405163e602df0560e01b81525f6004820152602401610381565b6001600160a01b03831661044d57604051634a1406b160e11b81525f6004820152602401610381565b6001600160a01b038085165f908152600160209081526040808320938716835292905220829055801561039857826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516104bf91815260200190565b60405180910390a350505050565b6001600160a01b0383166104f7578060025f8282546104ec919061072e565b909155506105679050565b6001600160a01b0383165f90815260208190526040902054818110156105495760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401610381565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b038216610583576002805482900390556105a1565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516105e691815260200190565b60405180910390a3505050565b602081525f82518060208401528060208501604085015e5f604082850101526040601f19601f83011684010191505092915050565b80356001600160a01b038116811461063e575f5ffd5b919050565b5f5f60408385031215610654575f5ffd5b61065d83610628565b946020939093013593505050565b5f5f5f6060848603121561067d575f5ffd5b61068684610628565b925061069460208501610628565b929592945050506040919091013590565b5f602082840312156106b5575f5ffd5b6106be82610628565b9392505050565b5f5f604083850312156106d6575f5ffd5b6106df83610628565b91506106ed60208401610628565b90509250929050565b600181811c9082168061070a57607f821691505b60208210810361072857634e487b7160e01b5f52602260045260245ffd5b50919050565b8082018082111561023a57634e487b7160e01b5f52601160045260245ffdfea26469706673582212202546764749a0dad93deca3d468162c1fb99eec30769182b909cbc49e171b54be64736f6c634300081e0033";

self.onmessage = ({ data }) => {
    const { name, symbol, uri } = data;

    try {
        const encodedArgs = ethers.AbiCoder.defaultAbiCoder().encode(
            ["string", "string", "string"],
            [name, symbol, uri]
        );

        const initCode = ethers.concat([MEME_BYTECODE, encodedArgs]);
        const initCodeHash = ethers.keccak256(initCode);

        let i = 0n;
        const batchSize = 1000n;

        while (true) {
            for (let j = 0n; j < batchSize; j++) {
                const salt = ethers.zeroPadValue(ethers.toBeHex(i), 32);

                const hash = ethers.keccak256(
                    ethers.concat([
                        "0xff",
                        FACTORY_ADDRESS,
                        salt,
                        initCodeHash
                    ])
                );

                const addr = "0x" + hash.slice(-40);

                if (addr.toLowerCase().endsWith("777")) {
                    self.postMessage({ type: 'found', salt, addr });
                    return;
                }

                i++;
            }

            // Yield to main thread every batch to allow message handling if needed
            // and report progress
            if (i % 100000n === 0n) {
                self.postMessage({ type: 'progress', count: i.toString() });
            }
        }
    } catch (error) {
        self.postMessage({ type: 'error', message: error.message });
    }
};
